generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                      String                   @id @default(cuid())
  email                   String                   @unique
  passwordHash            String
  emailVerified           Boolean                  @default(false)
  accountLocked           Boolean                  @default(false)
  failedLoginAttempts     Int                      @default(0)
  lastFailedLogin         DateTime?
  lockedUntil             DateTime?
  lastLoginAt             DateTime?
  mfaEnabled              Boolean                  @default(false)
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  role                    UserRole                 @default(USER)
  authAttempts            AuthAttempt[]
  businesses              Business[]
  emailVerificationTokens EmailVerificationToken[]
  inquiryReplies          InquiryReply[]
  mfaBackupCodes          MfaBackupCode[]
  mfaSecret               MfaSecret?
  mfaTempTokens           MfaTempToken[]
  passwordResetTokens     PasswordResetToken[]
  securityLogs            SecurityLog[]
  sessions                Session[]
  invitationsSent         TeamInvitation[]         @relation("InvitedInvitations")
  trustedDevices          TrustedDevice[]
  businessMemberships     BusinessMember[]

  @@map("users")
}

model TeamInvitation {
  id            String    @id @default(cuid())
  businessId    String
  email         String
  role          BusinessRole @default(STAFF)
  token         String    @unique
  status        String    @default("PENDING")
  invitedBy     String
  expiresAt     DateTime
  acceptedAt    DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  business      Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  invitedByUser User      @relation("InvitedInvitations", fields: [invitedBy], references: [id], onDelete: Cascade)

  @@unique([businessId, email])
  @@index([email])
  @@index([token])
  @@index([status])
  @@map("team_invitations")
}

model BusinessMember {
  id         String   @id @default(cuid())
  businessId String
  userId     String
  role       BusinessRole @default(STAFF)
  
  // Timestamps
  joinedAt   DateTime @default(now())
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  // Relations
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([businessId, userId])
  @@index([businessId])
  @@index([userId])
  @@map("business_members")
}

model Session {
  id             String   @id @default(cuid())
  userId         String
  token          String   @unique
  refreshToken   String?  @unique
  deviceInfo     String?
  ipAddress      String?
  userAgent      String?
  expiresAt      DateTime
  lastActivityAt DateTime @default(now())
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("sessions")
}

model AuthAttempt {
  id            String   @id @default(cuid())
  userId        String?
  email         String
  success       Boolean
  ipAddress     String
  userAgent     String?
  attemptType   String
  failureReason String?
  createdAt     DateTime @default(now())
  user          User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([email])
  @@index([ipAddress])
  @@index([createdAt])
  @@map("auth_attempts")
}

model PasswordResetToken {
  id        String    @id @default(cuid())
  userId    String
  token     String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("password_reset_tokens")
}

model EmailVerificationToken {
  id         String    @id @default(cuid())
  userId     String
  token      String    @unique
  email      String
  expiresAt  DateTime
  verifiedAt DateTime?
  createdAt  DateTime  @default(now())
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("email_verification_tokens")
}

model MfaSecret {
  id              String   @id @default(cuid())
  userId          String   @unique
  encryptedSecret String
  iv              String
  verified        Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("mfa_secrets")
}

model MfaBackupCode {
  id         String    @id @default(cuid())
  userId     String
  hashedCode String
  usedAt     DateTime?
  createdAt  DateTime  @default(now())
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("mfa_backup_codes")
}

model MfaTempToken {
  id        String    @id @default(cuid())
  userId    String
  token     String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("mfa_temp_tokens")
}

model SecurityLog {
  id        String   @id @default(cuid())
  userId    String?
  action    String
  details   Json?
  ipAddress String
  userAgent String?
  severity  String
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([action])
  @@index([severity])
  @@index([createdAt])
  @@map("security_logs")
}

model RateLimit {
  id          String   @id @default(cuid())
  key         String
  endpoint    String
  count       Int      @default(0)
  windowStart DateTime @default(now())
  expiresAt   DateTime
  userAgent   String?
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([key, endpoint])
  @@index([key])
  @@index([endpoint])
  @@index([expiresAt])
  @@map("rate_limits")
}

model RateLimitConfig {
  id              String   @id @default(cuid())
  endpoint        String   @unique
  maxAttempts     Int
  windowMs        Int
  blockDurationMs Int?
  isActive        Boolean  @default(true)
  description     String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([endpoint])
  @@index([isActive])
  @@map("rate_limit_configs")
}

model Business {
  id                String            @id @default(cuid())
  ownerId           String
  name              String
  slug              String            @unique
  category          BusinessCategory
  description       String?
  tagline           String?
  email             String?
  phone             String?
  website           String?
  address           String?
  city              String?
  state             String?
  zipCode           String?
  country           String?           @default("UK")
  latitude          Float?
  longitude         Float?
  timezone          String            @default("BST/LONDON")
  logoUrl           String?
  coverImageUrl     String?
  socialLinks       Json?
  settings          Json?
  branding          Json?
  isPublished       Boolean           @default(false)
  isPremium         Boolean           @default(false)
  isActive          Boolean           @default(true)
  seoTitle          String?
  seoDescription    String?
  seoKeywords       String[]
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  publishedAt       DateTime?
  appointments      Appointment[]
  businessHours     BusinessHours[]
  specialDates     SpecialDate[]
  owner             User              @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  customers         Customer[]
  faqs              FAQ[]
  inquiries         Inquiry[]
  reviews           Review[]
  serviceCategories ServiceCategory[]
  services          Service[]
  teamInvitations   TeamInvitation[]
  members           BusinessMember[]
  pages       Page[]

  @@index([ownerId])
  @@index([slug])
  @@index([category])
  @@index([isPublished])
  @@index([city, state])
  @@map("businesses")
}

model Page {
  id          String   @id @default(cuid())
  businessId  String
  business    Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  slug        String   // e.g., "home", "about", "services"
  title       String
  isPublished Boolean  @default(false)
  order       Int      @default(0)
  
  // Flexible content structure stored as JSONB
  content     Json     @default("[]") // Array of section objects
  
  // SEO
  metaTitle       String?
  metaDescription String?

    // NEW FIELDS - Add these
  publishedContent Json?    // Last published version
  publishedAt      DateTime?
  lastPublishedBy  String?   // User ID who published
  version          Int      @default(1) // Auto-increment on publish
  
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([businessId, slug])
  @@index([businessId])
  @@index([businessId, isPublished])
}
 
enum SectionType {
  HERO
  ABOUT
  SERVICES
  GALLERY
  CONTACT
  FAQ
  TESTIMONIALS
  CUSTOM_HTML
}

model BusinessHours {
  id         String   @id @default(cuid())
  businessId String
  dayOfWeek  Int
  openTime   String
  closeTime  String
  isClosed   Boolean  @default(false)
  notes      String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([businessId, dayOfWeek])
  @@index([businessId])
  @@map("business_hours")
}

model SpecialDate {
  id          String   @id @default(cuid())
  businessId  String
  date        DateTime @db.Date
  name        String
  isClosed    Boolean  @default(true)
  openTime    String?
  closeTime   String?
  notes       String?
  isRecurring Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  business    Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([businessId, date])
  @@index([businessId])
  @@index([businessId, date])
  @@map("special_dates")
}

model Service {
  id                    String           @id @default(cuid())
  businessId            String
  name                  String
  description           String?
  tagline               String?
  price                 Decimal          @db.Decimal(10, 2)
  priceType             PriceType        @default(FIXED)
  priceRangeMin         Decimal?         @db.Decimal(10, 2)
  priceRangeMax         Decimal?         @db.Decimal(10, 2)
  currency              String           @default("GBP")
  duration              Int
  bufferTime            Int              @default(0)
  categoryId            String?
  imageUrl              String?
  galleryImages         String[]
  requiresApproval      Boolean          @default(false)
  requiresDeposit       Boolean          @default(false)
  depositAmount         Decimal?         @db.Decimal(10, 2)
  maxAdvanceBookingDays Int?
  featured              Boolean          @default(false)
  active                Boolean          @default(true)
  order                 Int              @default(0)
  seoTitle              String?
  seoDescription        String?
  preparationNotes      String?
  aftercareNotes        String?
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  appointments          Appointment[]
  business              Business         @relation(fields: [businessId], references: [id], onDelete: Cascade)
  category              ServiceCategory? @relation(fields: [categoryId], references: [id])

  @@index([businessId])
  @@index([categoryId])
  @@index([active])
  @@index([featured])
  @@index([order])
  @@map("services")
}

model ServiceCategory {
  id          String    @id @default(cuid())
  businessId  String
  name        String
  description String?
  order       Int       @default(0)
  color       String?
  icon        String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  business    Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  services    Service[]

  @@unique([businessId, name])
  @@index([businessId])
  @@map("service_categories")
}

model Appointment {
  id                 String              @id @default(cuid())
  businessId         String
  serviceId          String
  customerId         String
  startTime          DateTime
  endTime            DateTime
  duration           Int
  timezone           String
  status             AppointmentStatus   @default(PENDING)
  previousStatus     AppointmentStatus?
  confirmedAt        DateTime?
  confirmedBy        String?
  completedAt        DateTime?
  cancelledAt        DateTime?
  cancellationSource CancellationSource?
  cancellationReason String?
  cancelledBy        String?
  rescheduledFrom    String?
  rescheduledTo      String?
  rescheduledAt      DateTime?
  rescheduleReason   String?
  customerName       String
  customerEmail      String
  customerPhone      String?
  customerNotes      String?
  businessNotes      String?
  requiresDeposit    Boolean             @default(false)
  depositAmount      Decimal?            @db.Decimal(10, 2)
  depositPaid        Boolean             @default(false)
  depositPaidAt      DateTime?
  totalAmount        Decimal             @db.Decimal(10, 2)
  paymentStatus      PaymentStatus       @default(UNPAID)
  paidAt             DateTime?
  reminderSentAt     DateTime?
  reminderCount      Int                 @default(0)
  bookingSource      String?
  bookingIp          String?
  metadata           Json?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  business           Business            @relation(fields: [businessId], references: [id], onDelete: Cascade)
  customer           Customer            @relation(fields: [customerId], references: [id])
  service            Service             @relation(fields: [serviceId], references: [id])

  @@index([businessId])
  @@index([serviceId])
  @@index([customerId])
  @@index([startTime])
  @@index([status])
  @@index([customerEmail])
  @@index([createdAt])
  @@map("appointments")
}

model Customer {
  id                String        @id @default(cuid())
  businessId        String
  email             String
  name              String
  firstName         String?
  lastName          String?
  phone             String?
  alternatePhone    String?
  address           String?
  city              String?
  state             String?
  zipCode           String?
  country           String?       @default("UK")
  birthday          DateTime?
  gender            String?
  preferredLanguage String?       @default("en")
  preferences       Json?
  emailOptIn        Boolean       @default(true)
  smsOptIn          Boolean       @default(false)
  marketingOptIn    Boolean       @default(false)
  tags              String[]
  customFields      Json?
  notes             String?
  privateNotes      String?
  isVip             Boolean       @default(false)
  isBlocked         Boolean       @default(false)
  blockReason       String?
  totalBookings     Int           @default(0)
  completedBookings Int           @default(0)
  cancelledBookings Int           @default(0)
  noShowCount       Int           @default(0)
  totalSpent        Decimal       @default(0) @db.Decimal(10, 2)
  averageRating     Decimal?      @db.Decimal(3, 2)
  firstBookingAt    DateTime?
  lastBookingAt     DateTime?
  lastContactedAt   DateTime?
  source            String?
  referredBy        String?
  metadata          Json?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  appointments      Appointment[]
  business          Business      @relation(fields: [businessId], references: [id], onDelete: Cascade)
  inquiries         Inquiry[]
  reviews           Review[]

  @@unique([businessId, email])
  @@index([businessId])
  @@index([email])
  @@index([phone])
  @@index([tags])
  @@index([isVip])
  @@index([lastBookingAt])
  @@map("customers")
}

model Review {
  id               String    @id @default(cuid())
  businessId       String
  customerId       String
  appointmentId    String?
  rating           Int
  title            String?
  comment          String?
  isPublished      Boolean   @default(false)
  isVerified       Boolean   @default(false)
  businessResponse String?
  respondedAt      DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  business         Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  customer         Customer  @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([customerId])
  @@index([rating])
  @@index([isPublished])
  @@map("reviews")
}

model TrustedDevice {
  id                String    @id @default(cuid())
  userId            String
  deviceFingerprint String
  deviceName        String
  ipAddress         String
  userAgent         String
  lastUsedAt        DateTime  @default(now())
  revokedAt         DateTime?
  createdAt         DateTime  @default(now())
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, deviceFingerprint])
  @@index([userId])
  @@map("trusted_devices")
}

model FAQ {
  id         String   @id @default(cuid())
  businessId String
  question   String
  answer     String
  order      Int      @default(0)
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId, order])
  @@index([businessId, isActive])
  @@map("faqs")
}

model Inquiry {
  id            String          @id @default(cuid())
  businessId    String
  customerId    String?
  customerEmail String
  customerName  String
  customerPhone String?
  subject       String
  message       String
  status        InquiryStatus   @default(PENDING)
  priority      InquiryPriority @default(NORMAL)
  isRead        Boolean         @default(false)
  ipAddress     String?
  userAgent     String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  business      Business        @relation(fields: [businessId], references: [id], onDelete: Cascade)
  customer      Customer?       @relation(fields: [customerId], references: [id])
  replies       InquiryReply[]

  @@index([businessId, status])
  @@index([businessId, createdAt])
  @@index([customerEmail])
  @@map("inquiries")
}

model InquiryReply {
  id          String    @id @default(cuid())
  inquiryId   String
  message     String
  userId      String
  emailSent   Boolean   @default(false)
  emailSentAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  inquiry     Inquiry   @relation(fields: [inquiryId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([inquiryId, createdAt])
  @@map("inquiry_replies")
}

enum UserRole {
  USER
  ADMIN
  SUPERADMIN
}

enum BusinessRole {
  OWNER
  ADMIN
  STAFF
  VIEWER
}

enum BusinessCategory {
  SALON
  BARBERSHOP
  SPA
  MASSAGE
  NAILS
  BEAUTY
  FITNESS
  YOGA
  PERSONAL_TRAINING
  THERAPY
  COUNSELING
  TUTORING
  CONSULTING
  PHOTOGRAPHY
  VIDEOGRAPHY
  EVENT_PLANNING
  CATERING
  CLEANING
  HOME_SERVICES
  PET_SERVICES
  OTHER
}

enum PriceType {
  FIXED
  RANGE
  STARTING_AT
  FREE
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
  NO_SHOW
  RESCHEDULED
}

enum CancellationSource {
  CUSTOMER
  BUSINESS
  SYSTEM
}

enum PaymentStatus {
  UNPAID
  PARTIALLY_PAID
  PAID
  REFUNDED
  FAILED
}

enum InquiryStatus {
  PENDING
  OPEN
  REPLIED
  RESOLVED
  ARCHIVED
}

enum InquiryPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}
